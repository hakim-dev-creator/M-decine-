<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰ (Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¨Ø§Ø´Ø±Ø©)</title>
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            background-color: var(--card);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            border-top: 6px solid var(--primary);
        }

        h2 {
            text-align: center;
            margin: 0 0 1.5rem 0;
            color: var(--primary-dark);
        }

        /* --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© --- */
        .controls-header {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        select {
            flex-grow: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-add {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 48px;
            border-radius: 8px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .btn-add:hover {
            background-color: var(--primary-dark);
        }

        /* --- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø²Ù„Ù‚Ø© --- */
        .details-wrapper {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.5s cubic-bezier(0, 1, 0, 1), opacity 0.5s ease-in-out, margin-top 0.3s;
            margin-top: 0;
        }

        .details-wrapper.open {
            max-height: 4000px; 
            opacity: 1;
            margin-top: 20px;
            transition: max-height 0.8s ease-in-out, opacity 0.5s ease-in-out, margin-top 0.3s;
        }

        .details-card {
            background-color: #f1f5f9;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
            font-weight: 700;
            color: #475569;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: 0.3s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: white;
        }

        .result-field {
            background-color: #e0f2fe;
            border-color: var(--primary);
            color: #0369a1;
            font-weight: bold;
            text-align: center;
        }

        .day-label {
            text-align: center;
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ --- */
        .upload-area {
            border: 2px dashed #cbd5e1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            background: white;
            transition: 0.3s;
            position: relative;
            margin-bottom: 15px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .upload-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-label {
            color: #64748b;
            font-size: 0.9rem;
            pointer-events: none;
        }

        /* --- ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª (Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…Ø¨Ø³Ø·) --- */
        .files-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .file-row {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: 0.2s;
        }

        .file-row:hover {
            border-color: var(--primary);
            background-color: #f8fafc;
        }

        .file-name-link {
            flex-grow: 1;
            color: #334155;
            text-decoration: none;
            cursor: pointer;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 10px;
        }

        .file-name-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        .btn-delete-file {
            background: none;
            border: none;
            color: #ef4444;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            opacity: 0.6;
            transition: 0.2s;
        }

        .btn-delete-file:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© --- */
        .bottom-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            align-items: center;
        }

        .btn-delete {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        #saveIndicator {
            color: #10b981;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
        }

    </style>
</head>
<body>

<div class="container">
    <h2>Ù…Ø¯ÙŠØ± Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>
    
    <div class="controls-header">
        <select id="patientSelect" onchange="loadSelectedPatient()">
            <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶Ø§Ù‹ --</option>
        </select>
        <button class="btn-add" onclick="createNewPatient()" title="Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯">+</button>
    </div>

    <div id="detailsPanel" class="details-wrapper">
        <div class="details-card">
            
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                <input type="text" id="p_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" oninput="updateCurrentData()">
            </div>

            <hr style="border-top:1px dashed #cbd5e1; margin: 15px 0;">

            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ø¬</label>
                <input type="text" id="p_treatment" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙˆØ±Ø³ Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ" oninput="updateCurrentData()">
            </div>

            <div class="form-group">
                <label>Ù…Ø¯Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ (Ø£ÙŠØ§Ù…)</label>
                <input type="number" id="p_duration" placeholder="0" oninput="updateCurrentData()">
            </div>

            <div class="form-group">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                <input type="date" id="p_startDate" onchange="updateCurrentData()">
            </div>

            <div class="form-group">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</label>
                <input type="text" id="p_endDate" class="result-field" readonly>
                <div id="p_dayName" class="day-label"></div>
            </div>

            <hr style="border-top:1px dashed #cbd5e1; margin: 15px 0;">

            <div class="form-group">
                <label>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©</label>
                
                <div class="upload-area">
                    <input type="file" id="fileInput" class="upload-input" multiple onchange="handleFileUpload(this)">
                    <div class="upload-label">
                        + Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©
                    </div>
                </div>
                
                <div id="filesContainer" class="files-list">
                    </div>
            </div>

            <div class="bottom-actions">
                <button class="btn-delete" onclick="deleteCurrentPatient()">Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
                <span id="saveIndicator">ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“</span>
            </div>

        </div>
    </div>
</div>

<script>
    let patients = [];
    let currentId = null;

    window.onload = function() {
        const savedData = localStorage.getItem('patients_db_unlimited');
        if (savedData) {
            patients = JSON.parse(savedData);
        }
        renderDropdown();
        document.getElementById('detailsPanel').classList.remove('open');
        document.getElementById('patientSelect').value = "";
    };

    function createNewPatient() {
        const newId = Date.now();
        const newPatient = {
            id: newId,
            name: "Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯",
            treatment: "",
            duration: "",
            startDate: new Date().toISOString().split('T')[0],
            attachments: []
        };

        patients.push(newPatient);
        currentId = newId;
        
        saveToLocal();
        renderDropdown();
        document.getElementById('patientSelect').value = newId;
        loadSelectedPatient();
        
        setTimeout(() => {
            document.getElementById('p_name').focus();
            document.getElementById('p_name').select();
        }, 300);
    }

    function renderDropdown() {
        const select = document.getElementById('patientSelect');
        select.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶Ø§Ù‹ --</option>';
        patients.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.name;
            select.appendChild(option);
        });
        if (currentId) select.value = currentId;
    }

    function loadSelectedPatient() {
        const select = document.getElementById('patientSelect');
        const val = select.value;
        if (!val) return;

        currentId = parseInt(val);
        const patient = patients.find(p => p.id === currentId);
        
        if (patient) {
            document.getElementById('p_name').value = patient.name;
            document.getElementById('p_treatment').value = patient.treatment || "";
            document.getElementById('p_duration').value = patient.duration || "";
            document.getElementById('p_startDate').value = patient.startDate || "";
            if (!patient.attachments) patient.attachments = [];

            calculateDate();
            renderFiles();
            document.getElementById('detailsPanel').classList.add('open');
        }
    }

    function updateCurrentData() {
        if (!currentId) return;
        const patientIndex = patients.findIndex(p => p.id === currentId);
        if (patientIndex === -1) return;

        patients[patientIndex].name = document.getElementById('p_name').value || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
        patients[patientIndex].treatment = document.getElementById('p_treatment').value;
        patients[patientIndex].duration = document.getElementById('p_duration').value;
        patients[patientIndex].startDate = document.getElementById('p_startDate').value;

        const select = document.getElementById('patientSelect');
        const option = select.querySelector(`option[value="${currentId}"]`);
        if(option) option.textContent = patients[patientIndex].name;

        calculateDate();
        saveToLocal();
        showSaveEffect();
    }

    // --- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
    function handleFileUpload(input) {
        if (!currentId || !input.files.length) return;
        
        const patient = patients.find(p => p.id === currentId);

        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const attachment = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    type: file.type,
                    data: e.target.result 
                };

                patient.attachments.push(attachment);
                renderFiles();
                
                if(!saveToLocal()) {
                    patient.attachments.pop(); // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸
                    renderFiles();
                } else {
                    showSaveEffect();
                }
            };
            reader.readAsDataURL(file);
        });
        input.value = '';
    }

    // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø³Ø·: Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø± + Ø²Ø± Ø­Ø°Ù ÙÙ‚Ø·
    function renderFiles() {
        const container = document.getElementById('filesContainer');
        container.innerHTML = '';
        const patient = patients.find(p => p.id === currentId);
        if (!patient || !patient.attachments) return;

        patient.attachments.forEach(file => {
            const row = document.createElement('div');
            row.className = 'file-row';
            
            // Ø§Ù„Ù‡ÙŠÙƒÙ„: [Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ±Ù‚ÙŠØ©] [Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (Ø±Ø§Ø¨Ø·)] [Ø²Ø± Ø§Ù„Ø­Ø°Ù]
            row.innerHTML = `
                <span style="font-size:1.2rem;">ğŸ“„</span>
                <span class="file-name-link" onclick="openFile('${file.data}')" title="Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ù…Ù„Ù">
                    ${file.name}
                </span>
                <button class="btn-delete-file" onclick="deleteFile(${file.id})" title="Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù">Ã—</button>
            `;
            container.appendChild(row);
        });
    }

    function deleteFile(fileId) {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ")) return;
        const patient = patients.find(p => p.id === currentId);
        if (patient) {
            patient.attachments = patient.attachments.filter(f => f.id !== fileId);
            renderFiles();
            saveToLocal();
        }
    }
    
    // ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø©
    window.openFile = function(base64Data) {
        const win = window.open();
        win.document.write(`
            <style>body{margin:0; background:#333; height:100vh; display:flex; justify-content:center; align-items:center;}</style>
            <iframe src="${base64Data}" frameborder="0" style="border:0; width:100%; height:100%; background:white;" allowfullscreen></iframe>
        `);
    };

    function calculateDate() {
        const duration = parseInt(document.getElementById('p_duration').value);
        const startDateStr = document.getElementById('p_startDate').value;
        const outputField = document.getElementById('p_endDate');
        const dayLabel = document.getElementById('p_dayName');

        if (!duration || !startDateStr) {
            outputField.value = "";
            dayLabel.textContent = "";
            return;
        }

        const date = new Date(startDateStr);
        date.setDate(date.getDate() + (duration - 1));
        const formatted = date.toISOString().split('T')[0];
        outputField.value = formatted;
        
        const daysAr = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
        dayLabel.textContent = `ÙŠÙˆØ§ÙÙ‚ ÙŠÙˆÙ…: ${daysAr[date.getDay()]}`;
    }

    function saveToLocal() {
        try {
            localStorage.setItem('patients_db_unlimited', JSON.stringify(patients));
            return true;
        } catch (e) {
            alert("ØªÙ†Ø¨ÙŠÙ‡: Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù…ØªÙ„Ø¦Ø©! ÙŠØ±Ø¬Ù‰ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª.");
            return false;
        }
    }

    function deleteCurrentPatient() {
        if (confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§ØªÙ‡ØŸ")) {
            patients = patients.filter(p => p.id !== currentId);
            saveToLocal();
            currentId = null;
            renderDropdown();
            document.getElementById('detailsPanel').classList.remove('open');
            document.getElementById('patientSelect').value = "";
        }
    }

    function showSaveEffect() {
        const indicator = document.getElementById('saveIndicator');
        indicator.style.opacity = '1';
        setTimeout(() => indicator.style.opacity = '0', 1000);
    }
</script>

</body>
</html>
