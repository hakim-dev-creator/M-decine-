<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ - Ù†Ø³Ø®Ø© Ù†Ø¸ÙŠÙØ©</title>
    <style>
        :root {
            --primary: #0284c7;
            --primary-light: #e0f2fe;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: #334155;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        .main-header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-top: 5px solid var(--primary);
        }

        h2 { margin: 0 0 15px 0; text-align: center; color: var(--primary); }

        .patient-controls { display: flex; gap: 10px; }

        select {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
        }

        .btn-add-patient {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            border-radius: 8px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* --- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… --- */
        .section-card {
            background: var(--card-bg);
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .section-header {
            padding: 15px 20px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #475569;
            transition: background 0.2s;
        }

        .section-header:hover { background: #f8fafc; color: var(--primary); }
        .arrow { transition: transform 0.3s; font-size: 0.8rem; color: #94a3b8; }
        .section-card.active .arrow { transform: rotate(180deg); }
        .section-card.active .section-header { color: var(--primary); background: var(--primary-light); }

        .section-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
            background: white;
        }

        .section-content { padding: 20px; }

        /* --- Ø§Ù„Ø­Ù‚ÙˆÙ„ --- */
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: inherit;
            box-sizing: border-box;
        }

        textarea { resize: vertical; min-height: 60px; }

        /* --- Ø§Ù„Ø­Ø§Ø³Ø¨Ø© (Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„) --- */
        .calc-box {
            background-color: #f0f9ff;
            border: 2px dashed #7dd3fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .calc-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #0369a1;
            margin-bottom: 8px;
            text-align: center;
        }

        /* --- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­ÙŠØ© --- */
        .live-feedback-container {
            margin-top: 15px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #bae6fd;
            display: none;
        }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸ --- */
        .saved-progress-card {
            margin-top: 10px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .saved-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 5px;
        }

        .saved-status-text {
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #0369a1;
            margin-bottom: 8px;
        }

        .progress-track {
            background-color: #e2e8f0;
            height: 10px;
            border-radius: 5px;
            width: 100%;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* --- Ø²Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª --- */
        input[type="file"] { display: none; }
        .file-upload-label {
            display: block;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            text-align: center;
            cursor: pointer;
            color: #64748b;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .file-upload-label:hover { border-color: var(--primary); color: var(--primary); background: #f0f9ff; }

        .btn-save-entry {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }

        .entries-list { margin-top: 20px; border-top: 2px dashed var(--border); padding-top: 10px; }
        
        .entry-item {
            background: #f8fafc; padding: 12px; border-radius: 6px;
            margin-bottom: 12px; font-size: 0.9rem; position: relative;
            border-right: 4px solid var(--primary);
        }
        
        .entry-meta { font-size: 0.75rem; color: #64748b; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .btn-delete-entry { position: absolute; left: 10px; top: 10px; color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        
        .card-appointment .entry-item { border-color: #8b5cf6; } 
        .card-prescription .entry-item { border-color: #10b981; }
        .card-lab .entry-item { border-color: #f59e0b; }
        .card-vitals .entry-item { border-color: #ef4444; }

    </style>
</head>
<body>

<div class="container">
    
    <div class="main-header">
        <h2>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</h2>
        <div class="patient-controls">
            <select id="patientSelect" onchange="loadPatient()">
                <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ù„Ù Ù…Ø±ÙŠØ¶ --</option>
            </select>
            <button class="btn-add-patient" onclick="addPatient()">+</button>
        </div>
        <div id="currentPatientName" style="text-align:center; margin-top:10px; font-weight:bold; color:var(--secondary);"></div>
    </div>

    <div id="sectionsContainer" style="display:none;">

        <div class="section-card card-appointment" id="sec_appointments">
            <div class="section-header" onclick="toggleSection('sec_appointments')">
                <span>ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ©</span><span class="arrow">â–¼</span>
            </div>
            <div class="section-body">
                <div class="section-content">
                    <div class="input-row">
                        <input type="date" id="appt_date">
                        <input type="time" id="appt_time">
                    </div>
                    <input type="text" id="appt_note" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©...">
                    <button class="btn-save-entry" onclick="saveData('appointments')">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
                    <div class="entries-list" id="list_appointments"></div>
                </div>
            </div>
        </div>

        <div class="section-card card-prescription" id="sec_prescriptions">
            <div class="section-header" onclick="toggleSection('sec_prescriptions')">
                <span>ğŸ’Š Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ© (Rx)</span><span class="arrow">â–¼</span>
            </div>
            <div class="section-body">
                <div class="section-content">
                    
                    <div class="calc-box">
                        <div class="calc-title">ğŸ§® Ø­Ø§Ø³Ø¨Ø© ÙØªØ±Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
                        <div class="input-row">
                            <input type="number" id="calc_duration" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)" oninput="updateCalculatorLive()">
                            <input type="date" id="calc_startDate" onchange="updateCalculatorLive()">
                        </div>
                        
                        <div id="live_feedback" class="live-feedback-container">
                             <div id="live_text" class="saved-status-text"></div>
                             <div class="progress-track">
                                 <div id="live_bar" class="progress-fill"></div>
                             </div>
                        </div>
                    </div>
                    <textarea id="rx_details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª..."></textarea>
                    
                    <div style="margin-top:10px;">
                        <label for="rx_file" class="file-upload-label" id="rx_file_label">
                            ğŸ“ Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                        </label>
                        <input type="file" id="rx_file" onchange="updateLabel('rx_file', 'rx_file_label')">
                    </div>

                    <button class="btn-save-entry" onclick="saveData('prescriptions')">Ø­ÙØ¸ Ø§Ù„ÙˆØµÙØ© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
                    
                    <div class="entries-list" id="list_prescriptions"></div>
                </div>
            </div>
        </div>

        <div class="section-card card-lab" id="sec_labs">
            <div class="section-header" onclick="toggleSection('sec_labs')">
                <span>ğŸ”¬ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…Ø®ØªØ¨Ø±</span><span class="arrow">â–¼</span>
            </div>
            <div class="section-body">
                <div class="section-content">
                    <div class="input-row">
                        <input type="date" id="lab_date">
                        <input type="text" id="lab_name" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„">
                    </div>
                    <textarea id="lab_result" placeholder="Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
                    
                    <div style="margin-top:10px;">
                        <label for="lab_file" class="file-upload-label" id="lab_file_label">
                            ğŸ“ Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                        </label>
                        <input type="file" id="lab_file" onchange="updateLabel('lab_file', 'lab_file_label')">
                    </div>

                    <button class="btn-save-entry" onclick="saveData('labs')">Ø­ÙØ¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
                    <div class="entries-list" id="list_labs"></div>
                </div>
            </div>
        </div>

        <div class="section-card card-vitals" id="sec_vitals">
            <div class="section-header" onclick="toggleSection('sec_vitals')">
                <span>âš–ï¸ Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø·ÙˆÙ„</span><span class="arrow">â–¼</span>
            </div>
            <div class="section-body">
                <div class="section-content">
                    <div class="input-row">
                        <input type="date" id="vital_date">
                    </div>
                    <div class="input-row">
                        <input type="number" id="vital_weight" placeholder="Ø§Ù„ÙˆØ²Ù† (ÙƒØº)">
                        <input type="number" id="vital_height" placeholder="Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)">
                    </div>
                    <button class="btn-save-entry" onclick="saveData('vitals')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
                    <div class="entries-list" id="list_vitals"></div>
                </div>
            </div>
        </div>

        <div class="section-card" id="sec_notes">
            <div class="section-header" onclick="toggleSection('sec_notes')">
                <span>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</span><span class="arrow">â–¼</span>
            </div>
            <div class="section-body">
                <div class="section-content">
                    <div class="input-row">
                        <input type="date" id="note_date">
                    </div>
                    <textarea id="note_text" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
                    <button class="btn-save-entry" onclick="saveData('notes')">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
                    <div class="entries-list" id="list_notes"></div>
                </div>
            </div>
        </div>

        <div style="text-align:center; margin-top:30px;">
            <button onclick="deleteCurrentPatient()" style="color:#ef4444; background:none; border:none; text-decoration:underline; cursor:pointer;">Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶</button>
        </div>

    </div>
</div>

<script>
    let patients = [];
    let currentId = null;

    window.onload = function() {
        const saved = localStorage.getItem('emr_db_clean');
        if (saved) patients = JSON.parse(saved);
        renderPatientList();
    };

    function saveDB() {
        try {
            localStorage.setItem('emr_db_clean', JSON.stringify(patients));
        } catch(e) {
            alert("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù…ØªÙ„Ø¦Ø©.");
        }
    }

    function updateCalculatorLive() {
        const duration = parseInt(document.getElementById('calc_duration').value);
        const startDateStr = document.getElementById('calc_startDate').value;
        const feedbackBox = document.getElementById('live_feedback');
        const feedbackText = document.getElementById('live_text');
        const feedbackBar = document.getElementById('live_bar');

        if (!duration || !startDateStr) {
            feedbackBox.style.display = "none";
            return;
        }

        feedbackBox.style.display = "block";
        const calcData = calculateProgress(startDateStr, duration);

        feedbackText.textContent = calcData.text;
        feedbackBar.style.width = calcData.percent + "%";
        feedbackBar.style.backgroundColor = calcData.color;
    }

    function calculateProgress(startDateStr, duration) {
        const start = new Date(startDateStr);
        const end = new Date(start);
        end.setDate(end.getDate() + (parseInt(duration) - 1));
        
        const today = new Date();
        today.setHours(0,0,0,0); start.setHours(0,0,0,0); end.setHours(0,0,0,0);

        const dayNames = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
        const endDateFormatted = `${end.toISOString().split('T')[0]} (${dayNames[end.getDay()]})`;

        let text = "";
        let percent = 0;
        let color = "#10b981";

        if (today < start) {
            const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
            text = `â³ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø¨Ø¹Ø¯ ${diff} ÙŠÙˆÙ…`;
            percent = 0;
            color = "#cbd5e1";
        } else if (today > end) {
            text = `âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©`;
            percent = 100;
            color = "#94a3b8";
        } else {
            const total = parseInt(duration);
            const passed = Math.ceil((today - start) / (1000 * 60 * 60 * 24)) + 1;
            percent = (passed / total) * 100;
            const remaining = total - passed;
            text = `Ù†Ø´Ø·: Ø§Ù„ÙŠÙˆÙ… ${passed} Ù…Ù† ${total} (Ø¨Ù‚ÙŠ ${remaining} ÙŠÙˆÙ…)`;
            if(remaining === 0) color = "#f59e0b";
        }

        return { text, percent, color, endDateFormatted };
    }

    function generateSavedProgressBar(startStr, duration) {
        const data = calculateProgress(startStr, duration);
        return `
            <div class="saved-progress-card">
                <div class="saved-info-row">
                    <span>ğŸ“… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù„Ø§Ø¬: <strong>${data.endDateFormatted}</strong></span>
                </div>
                <div class="saved-status-text">${data.text}</div>
                <div class="progress-track">
                    <div class="progress-fill" style="width:${data.percent}%; background-color:${data.color};"></div>
                </div>
            </div>
        `;
    }

    function addPatient() {
        const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
        if (!name) return;
        const newPatient = { id: Date.now(), name: name, appointments: [], prescriptions: [], labs: [], vitals: [], notes: [] };
        patients.push(newPatient);
        saveDB(); renderPatientList();
        document.getElementById('patientSelect').value = newPatient.id;
        loadPatient();
    }

    function renderPatientList() {
        const sel = document.getElementById('patientSelect');
        sel.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ù„Ù Ù…Ø±ÙŠØ¶ --</option>';
        patients.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt); });
    }

    function loadPatient() {
        const val = document.getElementById('patientSelect').value;
        if (!val) return;
        currentId = parseInt(val);
        const p = patients.find(x => x.id === currentId);
        document.getElementById('currentPatientName').textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø´Ø·: ${p.name}`;
        document.getElementById('sectionsContainer').style.display = 'block';
        ['appointments', 'prescriptions', 'labs', 'vitals', 'notes'].forEach(t => renderList(t));
        document.querySelectorAll('.section-card').forEach(c => { c.classList.remove('active'); c.querySelector('.section-body').style.maxHeight = null; });
    }

    function deleteCurrentPatient() {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            patients = patients.filter(p => p.id !== currentId);
            saveDB(); renderPatientList();
            document.getElementById('sectionsContainer').style.display = 'none';
            document.getElementById('currentPatientName').textContent = '';
            currentId = null;
        }
    }

    function toggleSection(secId) {
        const card = document.getElementById(secId);
        const body = card.querySelector('.section-body');
        card.classList.toggle('active');
        if (card.classList.contains('active')) {
            body.style.maxHeight = body.scrollHeight + 200 + "px";
            setDefaults(secId);
        } else {
            body.style.maxHeight = null;
        }
    }

    function setDefaults(secId) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);

        if(secId === 'sec_appointments') {
            document.getElementById('appt_date').value = dateStr; document.getElementById('appt_time').value = timeStr;
        } else if(secId === 'sec_prescriptions') {
            // ØªÙ… Ø­Ø°Ù Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆØµÙØ© (rx_date, rx_time) Ù„Ø°Ø§ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…ØªÙ‡Ø§ Ù‡Ù†Ø§
            const calcDate = document.getElementById('calc_startDate');
            if(!calcDate.value) calcDate.value = dateStr;
            updateCalculatorLive(); 
        } else if(secId === 'sec_labs') {
            document.getElementById('lab_date').value = dateStr;
        } else if(secId === 'sec_vitals') {
            document.getElementById('vital_date').value = dateStr;
        } else if(secId === 'sec_notes') {
            document.getElementById('note_date').value = dateStr;
        }
    }

    function updateLabel(inputId, labelId) {
        const input = document.getElementById(inputId); const label = document.getElementById(labelId);
        if(input.files && input.files[0]) { label.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯: " + input.files[0].name; label.style.borderColor = "#10b981"; label.style.color = "#10b981"; }
    }

    function saveData(type) {
        const pIndex = patients.findIndex(p => p.id === currentId);
        if (pIndex === -1) return;

        const commitSave = (entryData) => {
            patients[pIndex][type].unshift(entryData);
            saveDB(); renderList(type);
            
            // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
            if(type === 'prescriptions') {
                document.getElementById('rx_details').value = '';
                document.getElementById('rx_file').value = '';
                document.getElementById('rx_file_label').textContent = 'ğŸ“ Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)';
                document.getElementById('rx_file_label').style = '';
                // ØªØµÙÙŠØ± Ø§Ù„Ø­Ø§Ø³Ø¨Ø©
                document.getElementById('calc_duration').value = '';
                document.getElementById('live_feedback').style.display = 'none';
            } else if (type === 'labs') {
                document.getElementById('lab_name').value = ''; document.getElementById('lab_result').value = ''; document.getElementById('lab_file').value = '';
                document.getElementById('lab_file_label').textContent = 'ğŸ“ Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„'; document.getElementById('lab_file_label').style = '';
            } else if (type === 'appointments') { document.getElementById('appt_note').value = ''; } 
            else if (type === 'vitals') { document.getElementById('vital_weight').value = ''; document.getElementById('vital_height').value = ''; } 
            else if (type === 'notes') { document.getElementById('note_text').value = ''; }
            
            const card = document.getElementById(`sec_${type}`);
            const body = card.querySelector('.section-body');
            body.style.maxHeight = body.scrollHeight + "px";
        };

        // Ø¥Ù†Ø´Ø§Ø¡ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø­Ø§Ù„ÙŠÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const now = new Date();
        const autoDate = now.toISOString().split('T')[0];
        const autoTime = now.toTimeString().split(' ')[0].substring(0, 5);

        let entry = {};
        if (type === 'prescriptions') {
            const details = document.getElementById('rx_details').value;
            if(!details) return alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØµÙØ©");
            
            const durationVal = document.getElementById('calc_duration').value;
            const startVal = document.getElementById('calc_startDate').value;
            
            entry = { 
                date: autoDate, // ØªØ§Ø±ÙŠØ® ØªÙ„Ù‚Ø§Ø¦ÙŠ
                time: autoTime, // ÙˆÙ‚Øª ØªÙ„Ù‚Ø§Ø¦ÙŠ
                details: details, file: null,
                treatmentDuration: durationVal || null, treatmentStart: startVal || null
            };
            const fileInput = document.getElementById('rx_file');
            if (fileInput.files.length > 0) readFileAndCommit(fileInput.files[0], entry, commitSave);
            else commitSave(entry);
        } else if (type === 'labs') {
            const name = document.getElementById('lab_name').value;
            if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„");
            entry = { date: document.getElementById('lab_date').value, name: name, result: document.getElementById('lab_result').value, file: null };
            const fileInput = document.getElementById('lab_file');
            if (fileInput.files.length > 0) readFileAndCommit(fileInput.files[0], entry, commitSave);
            else commitSave(entry);
        } else {
            if (type === 'appointments') entry = { date: document.getElementById('appt_date').value, time: document.getElementById('appt_time').value, note: document.getElementById('appt_note').value || "-" };
            else if (type === 'vitals') { entry = { date: document.getElementById('vital_date').value, weight: document.getElementById('vital_weight').value, height: document.getElementById('vital_height').value }; if(!entry.weight && !entry.height) return; }
            else if (type === 'notes') { entry = { date: document.getElementById('note_date').value, text: document.getElementById('note_text').value }; if(!entry.text) return; }
            commitSave(entry);
        }
    }

    function readFileAndCommit(file, entryObj, callback) {
        const reader = new FileReader();
        reader.onload = function(e) { entryObj.file = { name: file.name, data: e.target.result }; callback(entryObj); };
        reader.readAsDataURL(file);
    }

    function deleteEntry(type, index) {
        if(!confirm("Ø­Ø°ÙØŸ")) return;
        const p = patients.find(x => x.id === currentId); p[type].splice(index, 1);
        saveDB(); renderList(type);
    }

    function openAttachment(base64Data) {
        const win = window.open(); win.document.write(`<iframe src="${base64Data}" style="border:0; width:100%; height:100vh;" allowfullscreen></iframe>`);
    }

    function renderList(type) {
        const p = patients.find(x => x.id === currentId);
        const listDiv = document.getElementById(`list_${type}`);
        listDiv.innerHTML = '';
        if (!p[type] || p[type].length === 0) { listDiv.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:0.8rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>'; return; }
        
        p[type].forEach((item, index) => {
            let contentHtml = '', metaHtml = `<span>ğŸ—“ ${item.date}</span>`, attachmentHtml = '';
            if (item.file) attachmentHtml = `<div onclick="openAttachment('${item.file.data}')" class="attachment-link">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚</div>`;

            if (type === 'appointments') { metaHtml += ` <span>ğŸ•’ ${item.time}</span>`; contentHtml = `<strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${item.note}`; }
            else if (type === 'prescriptions') { 
                let progressHtml = "";
                if(item.treatmentDuration && item.treatmentStart) {
                    progressHtml = generateSavedProgressBar(item.treatmentStart, item.treatmentDuration);
                }
                contentHtml = `<div style="white-space: pre-wrap;">${item.details}</div>${attachmentHtml}${progressHtml}`; 
            }
            else if (type === 'labs') { contentHtml = `<strong>${item.name}</strong><br><span style="color:#475569">${item.result}</span>${attachmentHtml}`; }
            else if (type === 'vitals') { contentHtml = `ÙˆØ²Ù†: <strong>${item.weight || '-'}</strong> | Ø·ÙˆÙ„: <strong>${item.height || '-'}</strong>`; }
            else if (type === 'notes') { contentHtml = `<div style="white-space: pre-wrap;">${item.text}</div>`; }
            
            const div = document.createElement('div'); div.className = 'entry-item';
            div.innerHTML = `<div class="entry-meta">${metaHtml}</div><div>${contentHtml}</div><button class="btn-delete-entry" onclick="deleteEntry('${type}', ${index})">Ã—</button>`;
            listDiv.appendChild(div);
        });
    }
</script>

</body>
</html>
