<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartElec Pro - V35 Full Access</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root { 
            --primary: #2563eb; --primary-dark: #1e40af; --bg: #f8fafc; --surface: #ffffff; 
            --text-main: #0f172a; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --shadow-lux: 0 10px 30px rgba(0,0,0,0.05); --radius: 24px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Tajawal', sans-serif; background: linear-gradient(-45deg, #f1f5f9, #ffffff, #e2e8f0);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite; margin: 0; padding-bottom: 120px;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .app-header { background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); padding: 20px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-lux); display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 22px; color: var(--primary); font-weight: 900; font-family: 'Cairo'; }
        
        .status-wrapper { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.03); padding: 6px 12px; border-radius: 20px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; transition: 0.5s; }
        .status-online { background: var(--success); box-shadow: 0 0 12px var(--success); }
        .status-cached { background: var(--warning); box-shadow: 0 0 12px var(--warning); }
        .status-text { font-size: 11px; font-weight: 800; color: var(--text-sub); }

        .container { padding: 20px; max-width: 600px; margin: auto; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-lux); }
        .stat-card { flex: 1; padding: 20px; border-radius: 20px; color: white; }
        .bg-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-red { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }

        .big-btn { width: 100%; padding: 18px; border-radius: 20px; border: none; font-weight: 800; font-size: 15px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid #e2e8f0; color: #64748b; }
        
        .fab { position: fixed; bottom: 35px; left: 35px; width: 65px; height: 65px; background: var(--primary); color: white; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; z-index: 150; box-shadow: 0 12px 25px rgba(37, 99, 235, 0.4); }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .app-page { display: none; min-height: 100vh; animation: fadeIn 0.3s; }
        .active-page { display: block; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; }
    </style>
</head>
<body>

    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; align-items:center; justify-content:center;">
        <div style="width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite;"></div>
    </div>

    <div id="loginOverlay">
        <h1 style="color:var(--primary); font-family:'Cairo'; font-weight:900;">SmartElec Pro</h1>
        <div style="width:100%; max-width:350px;">
            <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="width:100%; padding:15px; margin-bottom:12px; border-radius:15px; border:1px solid #ddd;">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width:100%; padding:15px; margin-bottom:20px; border-radius:15px; border:1px solid #ddd;">
            <button class="big-btn btn-primary" onclick="doLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”</button>
            <button class="big-btn btn-outline" style="margin-top:10px" onclick="doSignup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ âœ¨</button>
        </div>
        <p style="margin-top:20px; font-size:12px; color:#64748b;">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØµÙ…ÙŠÙ…: MEHEMLI ABDELHAKIM</p>
    </div>

    <div id="homePage" class="app-page active-page">
        <div class="app-header">
            <button onclick="auth.signOut()" style="background:none;border:none;color:var(--danger);font-weight:900;">Ø®Ø±ÙˆØ¬</button>
            <div class="status-wrapper">
                <span id="statusText" class="status-text">ØªØ­Ø¯ÙŠØ«..</span>
                <div id="statusDot" class="status-dot"></div>
                <span class="header-title" style="margin-right:10px">SmartElec</span>
            </div>
        </div>
        <div class="container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-family:'Cairo';">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                <button onclick="calculateDashboard(true)" style="background:none; border:none; color:var(--primary); font-size:26px;">ğŸ”„</button>
            </div>
            <div class="dash-row" style="display:flex; gap:15px;">
                <div class="stat-card bg-green"><small>Ù…Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±</small><h2 id="dashIncome">0 Ø¯Ø¬</h2></div>
                <div class="stat-card bg-red"><small>Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©</small><h2 id="dashDebt">0 Ø¯Ø¬</h2></div>
            </div>
            <div class="card">
                <h3>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                <select id="clientSelect" onchange="loadClientHistory()" style="width:100%; padding:18px; border-radius:20px; border:2px solid #eef2f6; font-size:16px; font-weight:700;">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>
                </select>
                <div id="invHistoryList" style="margin-top:25px;"></div>
            </div>
        </div>
        <button class="fab" onclick="goToServices()">+</button>
        <button class="fab" style="left:auto;right:35px;background:white;color:var(--primary);border:1px solid #ddd;" onclick="openModal('modalClient')">ğŸ‘¤</button>
    </div>

    <div id="servicesPage" class="app-page">
        <div class="app-header">
            <button onclick="goHome()" style="background:none;border:none;font-size:22px;">âœ</button>
            <span class="header-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span>
            <button onclick="openModal('modalProduct')" style="background:none;border:none;font-size:26px;color:var(--primary)">+</button>
        </div>
        <div id="servicesListContainer" class="container" style="padding-bottom:130px;"></div>
        <div style="position:fixed;bottom:0;width:100%;background:white;padding:22px;box-shadow:0 -8px 20px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center;z-index:200;">
            <b style="font-size:18px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="cartTotal">0</span></b>
            <button class="big-btn btn-primary" style="width:auto;padding:12px 35px" onclick="updateAndGoToInvoice()">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        </div>
    </div>

    <div id="invoicePage" class="app-page">
        <div class="app-header no-print">
            <button onclick="showPage('servicesPage')" style="background:none;border:none;color:var(--primary);font-weight:900;">âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</button>
            <span class="header-title">Ø§Ù„ÙØ§ØªÙˆØ±Ø©</span>
            <button onclick="generatePDF()" style="background:#111; color:#fff; border:none; padding:10px 20px; border-radius:15px;">ğŸ“„ PDF</button>
        </div>
        <div class="container">
            <div id="invoicePaper" class="card" style="padding:35px;">
                <h2 style="font-family:'Cairo'; margin-bottom:5px;">Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©</h2>
                <small>Ø³Ù…Ø§Ø±Øª Ø¥Ù„ÙƒØªØ±ÙŠÙƒ - MEHEMLI ABDELHAKIM</small>
                <hr style="margin:20px 0; border:1px solid #000;">
                <h4 id="invClientDisplay">Ø§Ù„Ø¹Ù…ÙŠÙ„: --</h4>
                <table style="width:100%; border-collapse:collapse;" id="invTable">
                    <thead><tr style="border-bottom:2px solid #000; text-align:right;"><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
                    <tbody id="invBody"></tbody>
                </table>
                <div style="margin-top:20px; text-align:left;">
                    <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="invTotalDisplay">0</b> Ø¯Ø¬</p>
                    <p style="color:var(--danger); font-size:20px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b id="invRestDisplay">0</b> Ø¯Ø¬</p>
                </div>
                <div class="no-print" style="margin-top:30px; border-top:1px dashed #ddd; padding-top:20px;">
                    <div id="paymentsList"></div>
                    <button class="big-btn" style="background:#dcfce7; color:#166534;" onclick="openModal('modalPayment')">+ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ© ğŸ’°</button>
                    <div id="saveActions" style="margin-top:15px"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalPayment" class="modal-overlay"><div class="modal-box"><h3>ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© ğŸ’°</h3><input type="number" id="inpPayAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="width:100%; padding:15px; border:2px solid var(--primary); border-radius:15px;"><p onclick="fillRemainingAmount()" style="color:var(--primary); cursor:pointer; font-size:13px; font-weight:bold; margin-top:10px; text-align:center;">âš¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p><input type="date" id="inpPayDate" style="width:100%; padding:15px; margin-top:10px; border-radius:12px; border:1px solid #ddd;"><button class="big-btn btn-primary" style="margin-top:20px" onclick="confirmPayment()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸</button><button class="big-btn btn-outline" style="margin-top:10px" onclick="closeModal('modalPayment')">Ø¥Ù„ØºØ§Ø¡</button></div></div>

    <div id="modalClient" class="modal-overlay"><div class="modal-box"><h3>Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ğŸ‘¤</h3><input id="inpClientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="width:100%; padding:15px; border-radius:15px; border:1px solid #ddd;"><input id="inpClientPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" style="width:100%; padding:15px; margin-top:10px; border-radius:15px; border:1px solid #ddd;"><button class="big-btn btn-primary" style="margin-top:20px" onclick="confirmAddClient()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button><button class="big-btn btn-outline" style="margin-top:10px" onclick="closeModal('modalClient')">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

    <div id="modalProduct" class="modal-overlay"><div class="modal-box"><h3>Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© ğŸ› ï¸</h3><input id="inpProdName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd;"><input type="number" id="inpProdPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="width:100%; padding:15px; margin-top:10px; border-radius:12px; border:1px solid #ddd;"><button class="big-btn btn-primary" style="margin-top:20px" onclick="confirmAddProduct()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDM8H7dyljf2NQDTnrh18eTGWYNxrdb2ZQ", authDomain: "smartelec-e3b4e.firebaseapp.com", projectId: "smartelec-e3b4e", storageBucket: "smartelec-e3b4e.firebasestorage.app", messagingSenderId: "875010638818", appId: "1:875010638818:web:33a69c8c3e1074a0fe6fbb" };
        firebase.initializeApp(firebaseConfig); 
        const db = firebase.firestore(); const auth = firebase.auth();
        db.enablePersistence().catch(()=>{});

        let user=null, products=[], cart={}, currentInv={items:[], payments:[], status:'open'}, activeInvId=null, activeClientId=null;

        auth.onAuthStateChanged(u => { if(u) { user=u; document.getElementById('loginOverlay').style.display='none'; initApp(); calculateDashboard(); } else { document.getElementById('loginOverlay').style.display='flex'; } });

        function doLogin() { showLoading(); auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPass').value).catch(err=>{hideLoading(); alert(err.message);}); }
        function doSignup() { showLoading(); auth.createUserWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPass').value).then(()=>{hideLoading(); alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");}).catch(err=>{hideLoading(); alert(err.message);}); }

        function updateSyncStatus(fromCache) {
            const dot = document.getElementById('statusDot'), text = document.getElementById('statusText');
            if (fromCache) { dot.className = 'status-dot status-cached'; text.innerText = 'ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†'; text.style.color = '#f59e0b'; }
            else { dot.className = 'status-dot status-online'; text.innerText = 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨'; text.style.color = '#10b981'; }
        }

        function initApp() {
            db.collection("Clients").where("uid","==",user.uid).onSnapshot({ includeMetadataChanges: true }, s => {
                updateSyncStatus(s.metadata.fromCache);
                const sel = document.getElementById('clientSelect'); const val = sel.value;
                sel.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>';
                s.forEach(d => sel.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`);
                if(val) sel.value = val;
            });
            db.collection("Products").where("uid","==",user.uid).onSnapshot(s => { products=[]; s.forEach(d => products.push({id:d.id, ...d.data()})); if(document.getElementById('servicesPage').classList.contains('active-page')) renderServices(); });
        }

        async function calculateDashboard(manual = false) {
            if(manual) showLoading();
            try {
                const snapshot = await db.collectionGroup('Invoices').where('uid', '==', user.uid).get();
                updateSyncStatus(snapshot.metadata.fromCache);
                let income = 0, debt = 0; const month = new Date().toISOString().slice(0,7);
                snapshot.forEach(doc => {
                    const data = doc.data(); debt += Number(data.remainingAmount || 0);
                    if(data.payments) data.payments.forEach(p => { if(p.date && p.date.startsWith(month)) income += Number(p.amount); });
                });
                document.getElementById('dashIncome').innerText = income.toLocaleString() + " Ø¯Ø¬";
                document.getElementById('dashDebt').innerText = debt.toLocaleString() + " Ø¯Ø¬";
            } catch(e) { console.error(e); }
            if(manual) hideLoading();
        }

        function loadClientHistory() {
            const cid = document.getElementById('clientSelect').value; if(!cid) return; activeClientId = cid;
            db.collection("Clients").doc(cid).collection("Invoices").orderBy("date","desc").onSnapshot(s => {
                const div = document.getElementById('invHistoryList'); div.innerHTML="";
                s.forEach(d => { const dat=d.data(); div.innerHTML+=`<div class="card" onclick="openInvoice('${cid}','${d.id}')" style="cursor:pointer; border-right:6px solid #2563eb; padding:15px; margin-bottom:10px;"><b>ÙØ§ØªÙˆØ±Ø© #${dat.invNum}</b> - ${dat.totalAmount} Ø¯Ø¬</div>`; });
            });
        }

        function openInvoice(cid, invId) {
            activeClientId=cid; activeInvId=invId; showLoading();
            db.collection("Clients").doc(cid).collection("Invoices").doc(invId).get().then(d => {
                const dat = d.data(); currentInv = { ...dat, date: dat.date.toDate() };
                cart = {}; if(currentInv.items) currentInv.items.forEach(it => { const p = products.find(prod => prod.name === it.name); if(p) cart[p.id]=it.qty; });
                renderInvoice(); hideLoading();
            });
        }

        function renderInvoice() {
            showPage('invoicePage');
            document.getElementById('invClientDisplay').innerText = "Ø§Ù„Ø¹Ù…ÙŠÙ„: " + document.getElementById('clientSelect').options[document.getElementById('clientSelect').selectedIndex].text;
            const tb = document.getElementById('invBody'); tb.innerHTML=""; let total = 0;
            currentInv.items.forEach(it => { total += it.price*it.qty; tb.innerHTML += `<tr><td>${it.name}</td><td>${it.qty}</td><td>${it.price*it.qty}</td></tr>`; });
            document.getElementById('invTotalDisplay').innerText = total.toLocaleString();
            let paid = 0; if(currentInv.payments) currentInv.payments.forEach(p => paid += Number(p.amount));
            document.getElementById('invRestDisplay').innerText = (total - paid).toLocaleString();
            document.getElementById('saveActions').innerHTML = `<button class="big-btn btn-primary" onclick="saveInvoice()">Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø© âœ…</button>`;
        }

        async function saveInvoice() {
            showLoading();
            const total = currentInv.items.reduce((a,b)=>a+(b.price*b.qty),0), paid = (currentInv.payments||[]).reduce((a,b)=>a+Number(b.amount),0);
            const data = { items: currentInv.items, payments: currentInv.payments||[], totalAmount: total, remainingAmount: total-paid, uid: user.uid };
            if(activeInvId) await db.collection("Clients").doc(activeClientId).collection("Invoices").doc(activeInvId).set(data, {merge:true});
            else {
                const cRef = db.collection('Counters').doc(user.uid); let num = 1;
                await db.runTransaction(async t => { const doc = await t.get(cRef); num = (doc.data()?.inv || 0) + 1; t.set(cRef, {inv:num}, {merge:true}); });
                data.invNum = num; data.date = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection("Clients").doc(activeClientId).collection("Invoices").add(data);
            }
            hideLoading(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­"); goHome(); calculateDashboard();
        }

        function confirmPayment() { const amt = document.getElementById('inpPayAmount').value; if(!amt) return; if(!currentInv.payments) currentInv.payments = []; currentInv.payments.push({ amount: amt, date: document.getElementById('inpPayDate').value || new Date().toISOString().split('T')[0] }); closeModal('modalPayment'); renderInvoice(); }
        function fillRemainingAmount() { const total = currentInv.items.reduce((a,b)=>a+(b.price*b.qty),0), paid = (currentInv.payments||[]).reduce((a,b)=>a+Number(b.amount),0); document.getElementById('inpPayAmount').value = total - paid; }
        
        function renderServices() { const div = document.getElementById('servicesListContainer'); div.innerHTML=""; products.forEach(p => { const q = cart[p.id] || 0; div.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px; margin-bottom:10px;"><div><b>${p.name}</b><br><small style="color:var(--primary); font-weight:bold;">${p.price} Ø¯Ø¬</small></div><input type="number" value="${q}" oninput="cart['${p.id}']=Number(this.value); calcCart();" style="width:70px; padding:12px; border-radius:12px; border:1px solid #ddd; text-align:center;"></div>`; }); calcCart(); }
        function calcCart() { let t=0; for(let id in cart) { const p=products.find(x=>x.id==id); if(p) t+=p.price*cart[id]; } document.getElementById('cartTotal').innerText = t.toLocaleString(); }
        function updateAndGoToInvoice() { currentInv.items = []; for(let id in cart) { const p=products.find(x=>x.id==id); if(p && cart[id]>0) currentInv.items.push({name:p.name, price:p.price, qty:cart[id]}); } if(currentInv.items.length===0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); renderInvoice(); }
        
        function confirmAddClient(){ const n=document.getElementById('inpClientName').value; db.collection("Clients").add({name:n, uid:user.uid, createdAt:new Date()}).then(()=>closeModal('modalClient')); }
        function confirmAddProduct(){ const n=document.getElementById('inpProdName').value, p=document.getElementById('inpProdPrice').value; db.collection("Products").add({name:n, price:Number(p), uid:user.uid}).then(()=>closeModal('modalProduct')); }
        function deleteActiveClient() { if(confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) db.collection("Clients").doc(activeClientId).delete().then(()=>location.reload()); }
        function deleteInvoice() { if(confirm("Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ")) db.collection("Clients").doc(activeClientId).collection("Invoices").doc(activeInvId).delete().then(()=>{ goHome(); calculateDashboard(); }); }
        function closeInvoice() { currentInv.status = 'closed'; saveInvoice(); }
        function startNewInvoice() { activeInvId = null; cart = {}; goToServices(); }
        function showPage(id) { document.querySelectorAll('.app-page').forEach(p=>p.classList.remove('active-page')); document.getElementById(id).classList.add('active-page'); if(id==='servicesPage') renderServices(); window.scrollTo(0,0); }
        function goHome() { showPage('homePage'); }
        function closeModal(m) { document.getElementById(m).style.display='none'; }
        function openModal(m) { document.getElementById(m).style.display='flex'; }
        function showLoading() { document.getElementById('loadingOverlay').style.display='flex'; }
        function hideLoading() { document.getElementById('loadingOverlay').style.display='none'; }
        function generatePDF() { html2pdf().from(document.getElementById('invoicePaper')).save(); }
        function goToServices() { if(!activeClientId) return alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); showPage('servicesPage'); }
    </script>
</body>
</html>
