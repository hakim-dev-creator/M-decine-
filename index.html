<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµØ­ØªÙŠ Ø¨Ø±Ùˆ</title>
    <link rel="manifest" href="manifest.json?v=FinalGreenHeart">
    <meta name="theme-color" content="#10b981">
    
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f9fafb; padding-bottom: 100px; user-select: none; overflow-x: hidden; }
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        .fab-btn { position: fixed; bottom: 90px; left: 20px; width: 60px; height: 60px; background-color: #10b981; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; shadow: 0 4px 15px rgba(16,185,129,0.4); z-index: 40; }
        .tab-btn.active { background-color: #10b981; color: white; border-color: #10b981; }
        
        #sidebar { position: fixed; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%; background: white; z-index: 200; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 4px 0 15px rgba(0,0,0,0.1); overflow-y: auto; }
        #sidebar.open { transform: translateX(0); }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150; display: none; }
        #overlay.show { display: block; }
        #details-page { display: none; }
        
        .pulse-green { animation: pulseG 2s infinite; }
        @keyframes pulseG { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 5px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .num-font { font-family: sans-serif; direction: ltr; display: inline-block; }
    </style>
</head>
<body>

    <aside id="sidebar">
        <div class="p-6 bg-green-600 text-white sticky top-0 z-10 shadow-md">
            <h2 class="text-2xl font-bold mb-1 flex items-center gap-2">
                <i class="fa-solid fa-heart-pulse"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </h2>
            <p class="text-xs opacity-80">Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰</p>
        </div>
        <div class="p-4">
            <h3 class="font-bold text-slate-700 mb-4 border-b pb-2 flex justify-between items-center">
                <span>Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</span>
                <span id="total-patients" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="sidebar-patients-list" class="space-y-4 pb-10"></div>
            </div>
    </aside>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <header class="bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="text-slate-700 text-xl p-2 rounded-full hover:bg-gray-100 transition">
                <i class="fa-solid fa-bars"></i>
            </button>
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-heart-pulse text-green-600 text-2xl"></i>
                ØµØ­ØªÙŠ
            </h1>
        </div>
        <div id="connection-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100 transition-all duration-300">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
            <span id="status-text" class="text-[10px] font-bold text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
        </div>
    </header>

    <main class="p-4">
        <section id="patients-page" class="page-section active">
            <h2 class="font-bold text-slate-700 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>
            <div id="patients-list" class="space-y-3 pb-20">
                <p class="text-center text-slate-400 mt-10">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
            <button onclick="document.getElementById('add-patient-modal').classList.remove('hidden')" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
        </section>

        <section id="details-page" class="fixed inset-0 bg-white z-[100] overflow-y-auto p-4 hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-4 sticky top-0 bg-white z-10 pt-2">
                <div>
                    <h2 id="detail-name" class="text-2xl font-bold text-slate-800">...</h2>
                    <p id="detail-age-display" class="text-xs text-green-600 font-bold mt-1">...</p>
                </div>
                <button onclick="closeDetails()" class="bg-slate-100 px-4 py-2 rounded-lg font-bold text-slate-600 shadow-sm active:scale-95">Ø¹ÙˆØ¯Ø© â†©ï¸</button>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                <button onclick="subTab('diagnosis')" id="btn-diagnosis" class="tab-btn active px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition">ØªØ´Ø®ÙŠØµ</button>
                <button onclick="subTab('analysis')" id="btn-analysis" class="tab-btn px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition">ØªØ­Ø§Ù„ÙŠÙ„</button>
                <button onclick="subTab('xray')" id="btn-xray" class="tab-btn px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition">Ø£Ø´Ø¹Ø©</button>
                <button onclick="subTab('measurements')" id="btn-measurements" class="tab-btn px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition">Ù‚ÙŠØ§Ø³Ø§Øª</button>
            </div>

            <div id="tab-content" class="pb-20">
                <div class="bg-green-50 p-4 rounded-xl border border-green-100 mb-4 shadow-sm">
                    <label id="input-label" class="text-xs font-bold text-green-600 block mb-2">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯</label>
                    <textarea id="record-input" rows="3" class="w-full p-3 rounded-xl border outline-none text-sm bg-white mb-2" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
                    
                    <div id="image-upload-area" class="hidden mb-2">
                        <label class="flex items-center gap-2 bg-white p-3 rounded-xl border border-dashed border-green-400 text-green-600 cursor-pointer justify-center hover:bg-green-50 transition">
                            <i class="fa-solid fa-camera"></i> <span id="file-label" class="text-xs font-bold">Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©</span>
                            <input type="file" id="record-file" accept="image/*" class="hidden" onchange="updateFileLabel()">
                        </label>
                    </div>

                    <div id="measure-inputs" class="hidden grid-cols-2 gap-2 mt-2">
                        <input id="m-weight" type="number" placeholder="ÙˆØ²Ù† (kg)" class="p-3 rounded-xl border outline-none bg-white">
                        <input id="m-height" type="number" placeholder="Ø·ÙˆÙ„ (cm)" class="p-3 rounded-xl border outline-none bg-white">
                        <input id="m-pressure" type="text" placeholder="Ø¶ØºØ·" class="p-3 rounded-xl border outline-none bg-white">
                        <input id="m-sugar" type="text" placeholder="Ø³ÙƒØ±" class="p-3 rounded-xl border outline-none bg-white">
                        <div class="col-span-2 text-[10px] text-slate-500 bg-white p-2 rounded border mt-1">â„¹ï¸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© "ØªØ­Ù„ÙŠÙ„ Ø·Ø¨ÙŠ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
                    </div>

                    <button id="save-btn" onclick="saveRecord()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mt-2 shadow-md active:scale-95 transition">Ø­ÙØ¸</button>
                </div>

                <h3 class="font-bold text-slate-700 mb-2 border-b pb-2">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</h3>
                <div id="history-list" class="space-y-3"></div>
            </div>
        </section>

        <section id="meds-page" class="page-section">
            <h2 class="font-bold text-slate-700 mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</h2>
            <div class="bg-white p-5 rounded-2xl border-t-4 border-green-500 shadow-sm mb-4 space-y-3">
                <select id="med-patient-select" class="w-full p-3 border rounded-xl bg-white font-bold h-12 outline-none focus:border-green-500"></select>
                <input id="med-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡..." class="w-full p-4 border rounded-xl outline-none focus:border-green-500">
                <div class="flex gap-2">
                    <input id="med-duration" type="number" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)" class="w-1/3 p-4 border rounded-xl text-center outline-none focus:border-green-500">
                    <input id="med-date" type="date" class="w-2/3 p-4 border rounded-xl text-sm outline-none bg-gray-50 font-bold focus:border-green-500">
                </div>
                <button onclick="savePrescription()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-green-700 active:scale-95 transition">Ø­ÙØ¸ Ø§Ù„ÙˆØµÙØ©</button>
            </div>
            <div id="prescriptions-list" class="space-y-3 pb-20"></div>
        </section>
    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 text-slate-400 text-sm z-50">
        <button onclick="switchPage('patients-page', this)" class="nav-item active w-1/2 flex flex-col items-center gap-1 text-green-600"><i class="fa-solid fa-user-group text-xl"></i><span class="font-bold">Ø§Ù„Ù…Ø±Ø¶Ù‰</span></button>
        <button onclick="switchPage('meds-page', this)" class="nav-item w-1/2 flex flex-col items-center gap-1"><i class="fa-solid fa-capsules text-xl"></i><span class="font-bold">Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</span></button>
    </nav>

    <div id="add-patient-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-[250]">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="font-bold mb-4">Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h3>
            <label class="text-xs font-bold text-slate-500 mb-1 block">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="new-p-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" class="w-full p-4 border rounded-xl mb-4 outline-none">
            <label class="text-xs font-bold text-slate-500 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
            <input id="new-p-dob" type="date" class="w-full p-4 border rounded-xl mb-6 outline-none bg-slate-50 text-slate-700 font-bold">
            <div class="flex gap-2">
                <button onclick="addPatient()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">Ø­ÙØ¸</button>
                <button onclick="document.getElementById('add-patient-modal').classList.add('hidden')" class="flex-1 bg-gray-100 py-3 rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="edit-patient-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-[250]">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="font-bold mb-4 text-lg text-slate-800"><i class="fa-solid fa-pen-to-square text-orange-500 ml-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <label class="text-xs font-bold text-slate-500 mb-1 block">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="edit-p-name" type="text" class="w-full p-4 border rounded-xl mb-4 outline-none focus:border-orange-500">
            <label class="text-xs font-bold text-slate-500 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
            <input id="edit-p-dob" type="date" class="w-full p-4 border rounded-xl mb-6 outline-none bg-slate-50 text-slate-700 font-bold focus:border-orange-500">
            <div class="flex gap-2">
                <button onclick="saveEditPatient()" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold hover:bg-orange-600">ØªØ­Ø¯ÙŠØ«</button>
                <button onclick="document.getElementById('edit-patient-modal').classList.add('hidden')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        const URL = 'https://zfwsnsbgbuciygwxtzdi.supabase.co/rest/v1';
        const STORAGE_URL = 'https://zfwsnsbgbuciygwxtzdi.supabase.co/storage/v1/object/images';
        
        // ğŸŸ¢ğŸŸ¢ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ø¯Ù…Ø¬ Ù‡Ù†Ø§ ÙˆÙ„Ù† ÙŠØ·Ù„Ø¨Ù‡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ø¨Ø¯Ø§Ù‹ ğŸŸ¢ğŸŸ¢
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpmd3Nuc2JnYnVjaXlnd3h0emRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNjIyNzcsImV4cCI6MjA4NTczODI3N30.xqgLLUg-Cdt12sEBe_QGnB90VcQ9zbPIDcgDc5OGljM";

        let currentPid = null, currentPName = "", currentPDob = null, currentTab = 'diagnosis';
        let allPatients = []; let editPid = null;

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('med-date').value = today;
            // ØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† ÙØ­Øµ Ù„Ù„Ù…ÙØªØ§Ø­
            fetchPatients(); 
            fetchPrescriptions(); 
            setInterval(checkRealConnection, 5000);
        });

        async function checkRealConnection() { try { const res = await fetch(`${URL}/patients?select=id&limit=1`, { headers: { ...getHeaders(), 'Cache-Control': 'no-store' } }); updateStatusUI(res.ok); } catch (e) { updateStatusUI(false); } }
        function updateStatusUI(isOnline) {
            const container = document.getElementById('connection-status');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (isOnline) { container.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 transition-all"; dot.className = "w-2 h-2 rounded-full bg-green-500 pulse-green"; text.innerText = "Ø³Ø­Ø§Ø¨ÙŠ âœ…"; text.className = "text-[10px] font-bold text-green-700"; } 
            else { container.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-orange-100 transition-all"; dot.className = "w-2 h-2 rounded-full bg-orange-500"; text.innerText = "Ø°Ø§ÙƒØ±Ø© âš ï¸"; text.className = "text-[10px] font-bold text-orange-700"; }
        }

        function getHeaders() { return { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' }; }
        function toggleSidebar() { const sb = document.getElementById('sidebar'); const ov = document.getElementById('overlay'); if(sb.classList.contains('open')) { sb.classList.remove('open'); ov.classList.remove('show'); } else { sb.classList.add('open'); ov.classList.add('show'); renderSidebarList(); } }
        function calculateAge(dobStr) { if(!dobStr) return null; const dob = new Date(dobStr); const today = new Date(); let years = today.getFullYear() - dob.getFullYear(); let months = today.getMonth() - dob.getMonth(); let days = today.getDate() - dob.getDate(); if (days < 0) { months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); } if (months < 0) { years--; months += 12; } return { Y: years, M: months, D: days }; }
        window.switchPage = (id, btn) => { document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active')); document.getElementById('details-page').style.display = 'none'; document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('text-green-600')); if(btn) btn.classList.add('text-green-600'); };

        async function fetchPatients() {
            try {
                const res = await fetch(`${URL}/patients?select=*&order=created_at.desc`, { headers: { ...getHeaders(), 'Cache-Control': 'no-store' } });
                const data = await res.json(); allPatients = data;
                const list = document.getElementById('patients-list'); const select = document.getElementById('med-patient-select'); document.getElementById('total-patients').innerText = data.length;
                if(data.length === 0) list.innerHTML = '<p class="text-center text-gray-400 mt-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰</p>';
                else {
                    list.innerHTML = data.map(p => `
                        <div onclick="openDetails('${p.id}', '${p.name}', '${p.dob || ''}')" class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center cursor-pointer active:bg-green-50 transition transform active:scale-95 mb-2">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center font-bold text-lg">${p.name.charAt(0)}</div><div><span class="font-bold text-slate-700 text-lg block">${p.name}</span><span class="text-[10px] text-slate-400">${p.dob ? 'ğŸ‚ ' + p.dob : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</span></div></div><i class="fa-solid fa-chevron-left text-gray-300"></i>
                        </div>`).join('');
                    select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ --</option>' + data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
                renderSidebarList();
            } catch (e) {}
        }

        function renderSidebarList() {
            const list = document.getElementById('sidebar-patients-list');
            list.innerHTML = allPatients.map(p => {
                const age = calculateAge(p.dob); const ageText = age ? `<span class="text-green-600 font-bold">${age.Y} Ø³Ù†Ø©</span>` : '<span class="text-slate-400 text-[10px]">--</span>';
                return `<div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-slate-600">${p.name.charAt(0)}</div><div><p class="text-sm font-bold text-slate-800">${p.name}</p><p class="text-[10px]">${ageText}</p></div></div><div class="flex gap-2"><button onclick="openEditPatient('${p.id}', '${p.name}', '${p.dob || ''}')" class="text-orange-400 hover:text-orange-600 p-1"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="deletePatient('${p.id}')" class="text-red-400 hover:text-red-600 p-1"><i class="fa-solid fa-trash-can"></i></button></div></div>`;
            }).join('');
        }

        async function addPatient() {
            const name = document.getElementById('new-p-name').value; const dob = document.getElementById('new-p-dob').value;
            if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
            try { await fetch(`${URL}/patients`, { method: 'POST', headers: getHeaders(), body: JSON.stringify({ name: name, dob: dob || null }) }); document.getElementById('add-patient-modal').classList.add('hidden'); document.getElementById('new-p-name').value = ''; document.getElementById('new-p-dob').value = ''; fetchPatients(); alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…"); } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£"); }
        }

        async function deletePatient(id) { if(!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return; try { const res = await fetch(`${URL}/patients?id=eq.${id}`, { method: 'DELETE', headers: getHeaders() }); if(res.ok) { alert("ØªÙ… Ø§Ù„Ø­Ø°Ù ğŸ—‘ï¸"); fetchPatients(); } } catch(e) { alert("Ø®Ø·Ø£"); } }
        function openEditPatient(id, name, dob) { editPid = id; document.getElementById('edit-p-name').value = name; document.getElementById('edit-p-dob').value = dob; document.getElementById('edit-patient-modal').classList.remove('hidden'); }
        async function saveEditPatient() { if(!editPid) return; const name = document.getElementById('edit-p-name').value; const dob = document.getElementById('edit-p-dob').value; try { const res = await fetch(`${URL}/patients?id=eq.${editPid}`, { method: 'PATCH', headers: getHeaders(), body: JSON.stringify({ name: name, dob: dob || null }) }); if(res.ok) { document.getElementById('edit-patient-modal').classList.add('hidden'); fetchPatients(); alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…"); } } catch(e) {} }

        window.openDetails = (id, name, dob) => { currentPid = id; currentPName = name; currentPDob = dob; document.getElementById('detail-name').innerText = name; const age = calculateAge(dob); document.getElementById('detail-age-display').innerText = age ? `Ø§Ù„Ø¹Ù…Ø±: ${age.Y} Ø³Ù†Ø© Ùˆ ${age.M} Ø£Ø´Ù‡Ø±` : "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ø±"; const page = document.getElementById('details-page'); page.style.display = 'block'; page.classList.remove('hidden'); subTab('diagnosis'); };
        window.closeDetails = () => { document.getElementById('details-page').style.display = 'none'; };
        window.subTab = (tab) => {
            currentTab = tab; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-'+tab).classList.add('active');
            const isMeas = tab === 'measurements'; const isImg = tab === 'xray' || tab === 'analysis';
            document.getElementById('measure-inputs').className = isMeas ? 'grid grid-cols-2 gap-2 mt-2' : 'hidden'; document.getElementById('image-upload-area').className = isImg ? 'mb-2' : 'hidden'; document.getElementById('record-input').className = isMeas ? 'hidden' : 'w-full p-3 rounded-xl border outline-none text-sm bg-white mb-2'; document.getElementById('input-label').innerText = isMeas ? 'ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ§Ø³Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©' : `Ø¥Ø¶Ø§ÙØ© ${tab === 'diagnosis' ? 'ØªØ´Ø®ÙŠØµ' : (tab === 'xray' ? 'ØªÙ‚Ø±ÙŠØ± Ø£Ø´Ø¹Ø©' : 'ØªØ­Ù„ÙŠÙ„')}`;
            document.getElementById('record-file').value = ''; document.getElementById('file-label').innerText = "Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©"; document.getElementById('file-label').classList.remove('text-green-600'); fetchHistory();
        };
        function updateFileLabel() { const input = document.getElementById('record-file'); if(input.files && input.files[0]) { document.getElementById('file-label').innerText = input.files[0].name; document.getElementById('file-label').classList.add('text-green-600'); } }
        function generateMedicalAnalysis(weight, height, ageObj) { if(!weight || !height) return ""; const bmi = (weight / ((height/100) * (height/100))).toFixed(1); let status = ""; let advice = ""; if (bmi < 18.5) { status = "Ù†Ù‚Øµ ÙÙŠ Ø§Ù„ÙˆØ²Ù†"; advice = "ÙŠÙˆØµÙ‰ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ©."; } else if (bmi < 25) { status = "ÙˆØ²Ù† Ø·Ø¨ÙŠØ¹ÙŠ ÙˆØµØ­ÙŠ âœ…"; advice = "Ù†Ù…Ùˆ ÙˆØªØ·ÙˆØ± Ù…Ù…ØªØ§Ø²ØŒ Ø§Ø³ØªÙ…Ø± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø·."; } else if (bmi < 30) { status = "Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„ÙˆØ²Ù†"; advice = "ÙŠÙ†ØµØ­ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª."; } else { status = "Ø³Ù…Ù†Ø©"; advice = "ØªØªØ·Ù„Ø¨ Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ø¨ÙŠØ© ÙˆØ¨Ø±Ù†Ø§Ù…Ø¬ ØºØ°Ø§Ø¦ÙŠ."; } let ageText = ageObj ? `ÙÙŠ Ø³Ù† ${ageObj.Y} Ø³Ù†Ø©` : ""; return `### ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ:\n- **Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©:** ${status} (${ageText})\n- **Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù… (BMI):** ${bmi}\n- **Ø§Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ©:** ${advice}`; }

        async function fetchHistory() {
            document.getElementById('history-list').innerHTML = '<p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';
            try {
                const res = await fetch(`${URL}/records?patient_id=eq.${currentPid}&type=eq.${currentTab}&order=created_at.desc`, { headers: { ...getHeaders(), 'Cache-Control': 'no-store' } });
                const data = await res.json();
                if(data.length === 0) { document.getElementById('history-list').innerHTML = '<p class="text-center text-gray-300 text-sm mt-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>'; } else { document.getElementById('history-list').innerHTML = data.map(r => { const date = r.created_at.split('T')[0]; let contentHtml = ''; if(currentTab === 'measurements') { contentHtml = `<div class="grid grid-cols-2 gap-2 text-sm mt-2 mb-2"><span class="bg-gray-50 p-1 rounded">ÙˆØ²Ù†: ${r.weight || '-'}</span><span class="bg-gray-50 p-1 rounded">Ø·ÙˆÙ„: ${r.height || '-'}</span><span class="bg-gray-50 p-1 rounded">Ø¶ØºØ·: ${r.pressure || '-'}</span><span class="bg-gray-50 p-1 rounded">Ø³ÙƒØ±: ${r.sugar || '-'}</span></div>`; if(r.content && r.content.includes("Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ")) contentHtml += `<div class="bg-blue-50 p-2 rounded text-[10px] text-slate-700 whitespace-pre-wrap border-r-2 border-blue-400">${r.content}</div>`; } else { const parts = r.content.split('|||'); const text = parts[0]; const imgUrl = parts.length > 1 ? parts[1] : null; contentHtml = `<p class="text-slate-700 mt-1 whitespace-pre-wrap">${text}</p>`; if(imgUrl) contentHtml += `<div class="mt-3"><a href="${imgUrl}" target="_blank" class="flex items-center gap-3 bg-gray-50 border border-gray-200 p-3 rounded-xl hover:bg-green-50 hover:border-green-200 transition group/btn"><div class="w-10 h-10 rounded-full bg-white border flex items-center justify-center shadow-sm text-green-600 group-hover/btn:scale-110 transition"><i class="fa-solid fa-image"></i></div><div class="flex-1"><p class="text-xs font-bold text-slate-700">Ù…Ø±ÙÙ‚ ØµÙˆØ±Ø©</p><p class="text-[10px] text-slate-400">Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶</p></div><i class="fa-solid fa-arrow-up-right-from-square text-slate-300 text-sm"></i></a></div>`; } return `<div class="bg-white p-3 rounded-xl border border-gray-100 relative group shadow-sm"><button onclick="deleteRecord('${r.id}')" class="absolute top-3 left-3 text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button><span class="text-[10px] bg-green-50 text-green-600 px-2 py-1 rounded font-bold">${date}</span>${contentHtml}</div>`; }).join(''); }
            } catch(e) {}
        }
        async function saveRecord() { if(!currentPid) return; const btn = document.getElementById('save-btn'); btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; const payload = { patient_id: currentPid, type: currentTab }; if(currentTab === 'measurements') { const w = document.getElementById('m-weight').value; const h = document.getElementById('m-height').value; payload.weight = w; payload.height = h; payload.pressure = document.getElementById('m-pressure').value; payload.sugar = document.getElementById('m-sugar').value; const ageObj = calculateAge(currentPDob); payload.content = generateMedicalAnalysis(w, h, ageObj); } else { let textContent = document.getElementById('record-input').value || "Ø¨Ø¯ÙˆÙ† ÙˆØµÙ"; const fileInput = document.getElementById('record-file'); if(fileInput.files && fileInput.files[0]) { btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©..."; const file = fileInput.files[0]; const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`; try { const uploadRes = await fetch(`${STORAGE_URL}/${fileName}`, { method: 'POST', headers: { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': file.type }, body: file }); if(uploadRes.ok) { const publicUrl = `${STORAGE_URL.replace('/object', '/object/public')}/${fileName}`; textContent += `|||${publicUrl}`; } else { alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©'); } } catch(e) { console.error(e); } } payload.content = textContent; } btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..."; await fetch(`${URL}/records`, { method: 'POST', headers: getHeaders(), body: JSON.stringify(payload) }); document.getElementById('record-input').value = ''; document.getElementById('record-file').value = ''; document.getElementById('file-label').innerText = "Ø§Ø¶ØºØ· Ù„Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©"; document.querySelectorAll('#measure-inputs input').forEach(i => i.value = ''); btn.innerText = "Ø­ÙØ¸"; fetchHistory(); }
        window.deleteRecord = async (id) => { if(confirm('Ø­Ø°ÙØŸ')) { await fetch(`${URL}/records?id=eq.${id}`, { method: 'DELETE', headers: getHeaders() }); fetchHistory(); } };

        async function fetchPrescriptions() {
            try {
                const res = await fetch(`${URL}/prescriptions?select=*&order=created_at.desc`, { headers: { ...getHeaders(), 'Cache-Control': 'no-store' } });
                const data = await res.json();
                let html = '';
                data.forEach(p => {
                    const start = new Date(p.date);
                    const end = new Date(start); 
                    const duration = parseInt(p.duration) || 0;
                    end.setDate(start.getDate() + duration);
                    const today = new Date();
                    const diffTime = end - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    let progress = 0;
                    if (duration > 0) { const passed = duration - diffDays; progress = Math.max(0, Math.min(100, (passed / duration) * 100)); }
                    const statusTxt = diffDays <= 0 ? 'Ù…Ù†ØªÙ‡ÙŠ' : `Ø¨Ø§Ù‚ÙŠ ${diffDays} ÙŠÙˆÙ…`;
                    const statusColor = diffDays <= 0 ? 'text-gray-400' : (diffDays <= 3 ? 'text-red-500' : 'text-green-600');
                    const barColor = diffDays <= 0 ? 'bg-gray-300' : (diffDays <= 3 ? 'bg-red-500' : 'bg-green-500');
                    const borderColor = diffDays <= 0 ? 'border-gray-300' : 'border-green-500';

                    html += `
                    <div class="bg-white p-4 rounded-xl border-l-4 ${borderColor} shadow-sm relative mb-3 group">
                        <button onclick="deletePrescription('${p.id}')" class="absolute top-4 left-4 text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>
                        <div class="pl-8 mb-2">
                            <h3 class="font-bold text-slate-800 text-lg flex items-center justify-between">
                                <span>${p.drug_name} ğŸ’Š</span>
                                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-[10px]">${p.patient_name}</span>
                            </h3>
                            <div class="mt-2 text-right border-r-2 border-slate-100 pr-2 mr-1">
                                <p class="text-[10px] text-slate-400 num-font mb-1">Ù…Ù†: ${p.date}</p>
                                <p class="text-sm font-bold text-slate-800">Ù…Ø¯Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬: <span class="num-font">${duration}</span> Ø£ÙŠØ§Ù…</p>
                                <p class="text-[10px] text-slate-400 num-font mt-1">Ø¥Ù„Ù‰: ${end.toISOString().split('T')[0]}</p>
                            </div>
                        </div>
                        <div class="flex justify-between text-xs font-bold text-slate-500 mb-1 mt-3">
                            <span></span>
                            <span class="${statusColor}">${statusTxt}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5">
                            <div class="${barColor} h-2.5 rounded-full transition-all duration-1000" style="width: ${progress}%"></div>
                        </div>
                    </div>`;
                });
                document.getElementById('prescriptions-list').innerHTML = html || '<p class="text-center text-slate-400 mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙØ§Øª</p>';
            } catch(e) {}
        }

        window.savePrescription = async () => { const pid = document.getElementById('med-patient-select').value; const drug = document.getElementById('med-name').value; if(!pid || !drug) return alert('Ù†Ø§Ù‚Øµ'); const select = document.getElementById('med-patient-select'); await fetch(`${URL}/prescriptions`, { method: 'POST', headers: getHeaders(), body: JSON.stringify({ patient_id: pid, patient_name: select.options[select.selectedIndex].text, drug_name: drug, date: document.getElementById('med-date').value, duration: document.getElementById('med-duration').value })}); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…'); fetchPrescriptions(); };
        window.deletePrescription = async (id) => { if(confirm('Ø­Ø°ÙØŸ')) { await fetch(`${URL}/prescriptions?id=eq.${id}`, { method: 'DELETE', headers: getHeaders() }); fetchPrescriptions(); } };
    </script>
</body>
</html>
